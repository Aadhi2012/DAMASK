# Makefile to compile the Material subroutine for BVP solution using spectral method with single precision
#
# BE SURE THAT ALL DOUBLE FILES ARE REMOVE FROM THE FOLDER
# Uses openmp to parallelise the material subroutines (set number of cores with "export MPIE_NUM_THREADS=n" to n)
# Uses linux threads to parallelise fftw3 (should also be possible with openmp)
# Besides of the f90 files written at MPIE, the two library files of fftw3 "libfftw3_threads.a" "libfftw3.a" are also needed
# Install fftw3 (v3.2.2 is tested) with "./configure --enable-threads --enable-float"  and "make", "make install" is not needed
# as long as the two library files are copied to the source code directory.

cpspectral_single.exe: mpie_spectral.o CPFEM.a
	ifort -openmp -o cpspectral_single.exe mpie_spectral.o CPFEM.a libfftw3f_threads.a libfftw3f.a constitutive.a advanced.a basics.a -lpthread
	rm *.mod

mpie_spectral.o: mpie_spectral.f90 CPFEM.o 
	ifort -openmp -c -O3 -heap-arrays 500000000 mpie_spectral.f90 

CPFEM.a: CPFEM.o
	ar rc CPFEM.a homogenization.o homogenization_RGC.o homogenization_isostrain.o crystallite.o CPFEM.o constitutive.o

CPFEM.o: CPFEM.f90 homogenization.o
	ifort -openmp -c -O3 -heap-arrays 500000000 CPFEM.f90
homogenization.o: homogenization.f90 homogenization_isostrain.o homogenization_RGC.o crystallite.o
	ifort -openmp -c -O3 -heap-arrays 500000000 homogenization.f90
homogenization_RGC.o: homogenization_RGC.f90 constitutive.a
	ifort -openmp -c -O3 -heap-arrays 500000000 homogenization_RGC.f90
homogenization_isostrain.o: homogenization_isostrain.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 homogenization_isostrain.f90
crystallite.o: crystallite.f90 constitutive.a
	ifort -openmp -c -O3 -heap-arrays 500000000 crystallite.f90



constitutive.a: constitutive.o
	ar rc constitutive.a constitutive.o constitutive_titanmod.o constitutive_nonlocal.o constitutive_dislotwin.o constitutive_j2.o constitutive_phenopowerlaw.o basics.a advanced.a

constitutive.o: constitutive.f90 constitutive_titanmod.o constitutive_nonlocal.o constitutive_dislotwin.o constitutive_j2.o constitutive_phenopowerlaw.o
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive.f90

constitutive_titanmod.o: constitutive_titanmod.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive_titanmod.f90

constitutive_nonlocal.o: constitutive_nonlocal.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive_nonlocal.f90

constitutive_dislotwin.o: constitutive_dislotwin.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive_dislotwin.f90

constitutive_j2.o: constitutive_j2.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive_j2.f90

constitutive_phenopowerlaw.o: constitutive_phenopowerlaw.f90 basics.a advanced.a
	ifort -openmp -c -O3 -heap-arrays 500000000 constitutive_phenopowerlaw.f90



advanced.a: lattice.o
	ar rc advanced.a FEsolving.o mesh.o material.o lattice.o

lattice.o: lattice.f90 material.o
	ifort -openmp -c -O3 -heap-arrays 500000000 lattice.f90
material.o: material.f90 mesh.o
	ifort -openmp -c -O3 -heap-arrays 500000000 material.f90
mesh.o: mesh.f90 FEsolving.o
	ifort -openmp -c -O3 -heap-arrays 500000000 mesh.f90
FEsolving.o: FEsolving.f90 basics.a
	ifort -openmp -c -O3 -heap-arrays 500000000 FEsolving.f90



basics.a: debug.o math_single.o
	ar rc basics.a debug.o math_single.o numerics.o IO.o mpie_spectral_interface.o prec_single.o

debug.o: debug.f90 numerics.o
	ifort -openmp -c -O3 debug.f90

math_single.o: math_single.f90 numerics.o
	ifort -openmp -c -O3 math_single.f90

numerics.o: numerics.f90 IO.o
	ifort -openmp -c -O3 numerics.f90
IO.o: IO.f90 mpie_spectral_interface.o
	ifort -openmp -c -O3 IO.f90
mpie_spectral_interface.o: mpie_spectral_interface.f90 prec_single.o
	ifort -openmp -c -O3 mpie_spectral_interface.f90
prec_single.o: prec_single.f90
	ifort -openmp -c -O3 prec_single.f90
